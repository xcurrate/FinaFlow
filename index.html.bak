<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinaFlow - Catatan Keuangan Pribadi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- 1. CSS GAYA VISUAL (UI/UX) --- */
        :root {
            --primary: #003366; /* Navy Blue */
            --bg: #f4f7f6;
            --white: #ffffff;
            --green: #28a745;
            --red: #dc3545;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        .container { max-width: 1000px; margin: 0 auto; }
        .hidden { display: none !important; }
        .card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Login Screen */
        .auth-box { max-width: 400px; margin: 10vh auto; text-align: center; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; }
        
        /* Dashboard Grid */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { text-align: center; padding: 15px; }
        .stat-val { font-size: 1.5rem; font-weight: bold; margin-top: 5px; }
        .green { color: var(--green); } .red { color: var(--red); } .blue { color: var(--primary); }

        /* Buttons */
        .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--red); color: white; width: auto; padding: 5px 10px; font-size: 0.8rem; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; color: #777; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* Print Mode */
        @media print {
            body { background: white; padding: 0; }
            .no-print, .auth-box, form, .btn, .chart-container { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <div id="auth-view" class="card auth-box">
        <h2 style="color:var(--primary)">FinaFlow üí∞</h2>
        <p>Kelola uangmu, atur masa depanmu.</p>
        <p id="auth-status" style="font-size:0.9rem; color:#666;">Siap menghubungkan...</p>

        <form onsubmit="handleAuth(event); return false;">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="btn btn-primary" id="btn-login">MASUK</button>
            <button type="button" class="btn btn-outline" onclick="handleRegister()">DAFTAR BARU</button>
        </form>
    </div>

    <div id="app-view" class="container hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:var(--primary);">Dashboard Keuangan</h2>
            <div>
                <span id="user-display" style="margin-right:10px; font-size:0.9rem;">User</span>
                <button onclick="logout()" class="btn btn-outline no-print" style="width:auto; padding:5px 15px;">Keluar</button>
            </div>
        </div>

        <div class="summary-grid">
            <div class="card stat-card">
                <small>Saldo Saat Ini</small>
                <div id="val-balance" class="stat-val blue">Rp 0</div>
            </div>
            <div class="card stat-card">
                <small>Pemasukan</small>
                <div id="val-inc" class="stat-val green">Rp 0</div>
            </div>
            <div class="card stat-card">
                <small>Pengeluaran</small>
                <div id="val-exp" class="stat-val red">Rp 0</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
            <div class="card no-print">
                <h3>‚ûï Tambah Transaksi</h3>
                <form onsubmit="addTransaction(event); return false;">
                    <input type="text" id="t-desc" placeholder="Keterangan (cth: Gaji, Makan Siang)" required>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="t-amount" placeholder="Nominal (Rp)" required>
                        <select id="t-type">
                            <option value="income">Pemasukan (+)</option>
                            <option value="expense">Pengeluaran (-)</option>
                        </select>
                    </div>
                    <input type="date" id="t-date" required>
                    <button type="submit" class="btn btn-primary">SIMPAN</button>
                </form>
            </div>

            <div class="card chart-container">
                <canvas id="myChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Riwayat Transaksi</h3>
                <button onclick="window.print()" class="btn btn-outline no-print" style="width:auto;">üñ®Ô∏è Cetak Laporan</button>
            </div>
            
            <div id="advice-box" style="background:#e2e6ea; padding:10px; border-radius:6px; margin:10px 0; font-size:0.9rem;">
                üí° Menunggu data untuk analisis...
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Keterangan</th>
                        <th>Nominal</th>
                        <th class="no-print">Aksi</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // =======================================================
        // ‚ö†Ô∏è SETUP KONEKSI (Jangan sampai salah lagi ya!)
        // =======================================================
        const SUPABASE_URL = 'https://sbxtfqidotarniglzban.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNieHRmcWlkb3Rhcm5pZ2x6YmFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMjgxODQsImV4cCI6MjA4MzgwNDE4NH0.MCiWNCcmQRBmAvAbsbcpdMbSOWAg7zPqJynpCLf1RKQ';
        
        // Inisialisasi
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;
        let myChart = null;

        // --- 1. LOGIC AUTH (LOGIN/REGISTER) ---
        
        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            setStatus("Sedang login...", "blue");

            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            
            if(error) {
                setStatus("Gagal: " + error.message, "red");
            } else {
                currentUser = data.user;
                setStatus("Berhasil!", "green");
                initApp();
            }
        }

        async function handleRegister() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if(!email || !password) return setStatus("Isi email & pass dulu!", "red");

            setStatus("Mendaftar...", "blue");
            const { data, error } = await sb.auth.signUp({ email, password });
            
            if(error) setStatus("Error: " + error.message, "red");
            else setStatus("Daftar Sukses! Silakan Login.", "green");
        }

        async function logout() {
            await sb.auth.signOut();
            location.reload();
        }

        function setStatus(msg, color) {
            const el = document.getElementById('auth-status');
            el.innerText = msg;
            el.style.color = color;
        }

        // --- 2. LOGIC APLIKASI UTAMA ---

        function initApp() {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('user-display').innerText = currentUser.email;
            document.getElementById('t-date').valueAsDate = new Date();
            loadTransactions();
        }

        // LOAD DATA (READ)
        async function loadTransactions() {
            const { data, error } = await sb
                .from('transactions') // Pastikan tabel ini ada di Supabase!
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            if(error) {
                console.error(error);
                alert("Belum ada tabel 'transactions'. Cek SQL Editor di Supabase!");
                return;
            }

            renderData(data);
        }

        // TAMBAH DATA (CREATE)
        async function addTransaction(e) {
            e.preventDefault();
            const desc = document.getElementById('t-desc').value;
            const amount = document.getElementById('t-amount').value;
            const type = document.getElementById('t-type').value;
            const date = document.getElementById('t-date').value;

            const { error } = await sb.from('transactions').insert([{
                user_id: currentUser.id,
                description: desc,
                amount: amount,
                type: type,
                date: date
            }]);

            if(error) alert("Gagal simpan: " + error.message);
            else {
                document.getElementById('t-desc').value = ""; // Reset form
                document.getElementById('t-amount').value = "";
                loadTransactions(); // Reload data
            }
        }

        // HAPUS DATA (DELETE)
        async function deleteItem(id) {
            if(!confirm("Hapus data ini?")) return;
            const { error } = await sb.from('transactions').delete().eq('id', id);
            if(!error) loadTransactions();
        }

        // --- 3. RENDER UI (Chart & Tabel) ---
        function renderData(transactions) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";

            let inc = 0, exp = 0;

            transactions.forEach(t => {
                // Hitung Total
                if(t.type === 'income') inc += Number(t.amount);
                else exp += Number(t.amount);

                // Buat Baris Tabel
                const row = `
                    <tr>
                        <td>${t.date}</td>
                        <td>${t.description}</td>
                        <td style="color:${t.type === 'income' ? 'green' : 'red'}">
                            ${t.type === 'income' ? '+' : '-'} Rp ${Number(t.amount).toLocaleString()}
                        </td>
                        <td class="no-print">
                            <button class="btn btn-danger" onclick="deleteItem(${t.id})">X</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update Kartu Atas
            document.getElementById('val-inc').innerText = "Rp " + inc.toLocaleString();
            document.getElementById('val-exp').innerText = "Rp " + exp.toLocaleString();
            document.getElementById('val-balance').innerText = "Rp " + (inc - exp).toLocaleString();

            // Update Saran
            const ratio = inc > 0 ? (exp / inc * 100) : 0;
            const adviceBox = document.getElementById('advice-box');
            if(ratio > 80) {
                adviceBox.style.background = "#ffe6e6";
                adviceBox.innerText = "‚ö†Ô∏è BAHAYA: Pengeluaranmu sudah " + ratio.toFixed(0) + "% dari pemasukan. HEMAT SEKARANG!";
            } else if(ratio < 50 && inc > 0) {
                adviceBox.style.background = "#e6fffa";
                adviceBox.innerText = "‚úÖ AMAN: Keuangan sehat. Pertahankan!";
            } else {
                adviceBox.innerText = "‚ÑπÔ∏è Info: Pengeluaranmu " + ratio.toFixed(0) + "%.";
            }

            // Update Chart
            updateChart(inc, exp);
        }

        function updateChart(inc, exp) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if(myChart) myChart.destroy(); // Hapus chart lama biar gak numpuk

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pemasukan', 'Pengeluaran'],
                    datasets: [{
                        data: [inc, exp],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                }
            });
        }
    </script>
</body>
</html>
